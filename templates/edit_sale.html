{% extends "base.html" %}

{% block title %}판매 기록 수정 - 재고관리 시스템{% endblock %}

{% block content %}
<h1>판매 기록 수정</h1>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<form method="post" action="/sales/edit/{{ sale.id }}" class="mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="product_id" class="form-label">상품 선택</label>
                <select class="form-select" id="product_id" name="product_id" required>
                    <option value="">상품을 선택하세요</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" {% if product.id == sale.product_id %}selected{% endif %}>
                        {{ product.name }}{% if product.options %} [{{ product.options }}]{% endif %} (재고: {{ product.quantity }}개, 가격: ₩{{ "{:,.0f}".format(product.price) }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label for="sale_date" class="form-label">판매일</label>
                <input type="date" class="form-control" id="sale_date" name="sale_date" value="{{ sale.sale_date }}" required>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label for="quantity" class="form-label">판매 수량</label>
                <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="{{ sale.quantity }}" required>
            </div>
            
            <div class="mb-3">
                <label for="platform" class="form-label">판매 플랫폼</label>
                <select class="form-select" id="platform" name="platform" required>
                    <option value="">플랫폼을 선택하세요</option>
                    <option value="네이버" {% if sale.platform == '네이버' %}selected{% endif %}>네이버</option>
                    <option value="쿠팡" {% if sale.platform == '쿠팡' %}selected{% endif %}>쿠팡</option>
                    <option value="자사몰" {% if sale.platform == '자사몰' %}selected{% endif %}>자사몰</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="alert alert-info">
        <strong>참고:</strong> 판매 기록을 수정하면 재고가 자동으로 조정됩니다.
    </div>
    
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">수정 완료</button>
        <a href="/sales" class="btn btn-secondary">취소</a>
    </div>
</form>

<script>
document.getElementById('product_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        const text = selectedOption.text;
        const stockMatch = text.match(/재고: (\d+)개/);
        if (stockMatch) {
            const maxStock = parseInt(stockMatch[1]);
            const currentQuantity = parseInt(document.getElementById('quantity').value);
            const saleQuantity = {{ sale.quantity }};
            // 수정 시 기존 판매 수량을 재고에 더해서 계산
            document.getElementById('quantity').max = maxStock + (selectedOption.value == {{ sale.product_id }} ? saleQuantity : 0);
        }
    }
});
</script>
{% endblock %}